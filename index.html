<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.6/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.6/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Text Highlighter</title>
  </head>
  <body>
    <div>
      <h3>Text HighLighter</h3>
      <div id='app'>
        <script type="text/babel">

          var inputText = "Google Pixel phones to be unveiled October 4. " +
          "The firm may also launch its voice-activated AI home audio speaker, a VR headset and a 4K Chromecast. " +
          "Google will unveil its latest Pixel smartphones on October 4, the firm has suggested through a teaser website. "+
          "It is believed the Nexus brand name will be dropped in favour of two new models: the Pixel and the Pixel XL. " +
          "Current rumours around the devices - which have been codenamed Sailfish and Marlin - say the devices will be 5-inch and 5.5-inch phones. At Google's developer conference in May CEO Sundar Pichai hinted that the new line would includes additional Google features built on top of the Android operating system. As such, Pixel is expected to become a premium brand. " +
          "The teaser website shows a search bar that morphs into the outline of a phone, before flashing with various images. The event will take place in San Francisco at 9AM PST (5PM BST), and be streamed on YouTube. Leaked images of the Pixel phones Leaked images of the Pixel phones Android Police. " +
          "At present the company controls the design and marketing of its Nexus products, with the manufacturing of the devices outsourced to third parties. This, according to Pichai earlier this year, will not change. " +
          "But there could also be more to come from the event. A previous report from Android Police has said the event will be packed with Google's latest products. " +
          "Rumoured to be launching that day will be a Google virtual reality headset, under the guise of the Google Daydream project; a 4K Chromecast, and its highly anticipated AI personal assistant device. " +
          "At its developer conference, Google announced a new voice-controlled, artificial intelligence Home speaker that will connect to devices around a building and be able to control them. The artificial intelligence based Google Home speaker The artificial intelligence based Google Home speaker Google. " +
          "The device will use a Google Assistant, which is being built into a new Google messages app called Allo - which is rumoured to be launching before the October event. \"With a simple voice command, you can ask Google Home to play a song, set a timer for the oven, check your flight, or turn on your lights,\" the firm said at the time. " +
          "Any home device would be a rival to Amazon's Echo, which launched in the UK on September 16. The Echo uses Amazon's own personal assistant, Alexa, to control internet of things devices as well as provide news, weather, and travel updates. " +
          "Although the teaser website doesn't reference any of these products, Google previously said its Home device would launch before the end of 2016. ";

          var App = React.createClass({
            getInitialState() {
              return {
                  selectedItems: [],
                  showAlert: false,
                  currentColor: '#5499C7',
              }
            },
            render() {
              var displayError = {
                visibility: this.state.showAlert === false ? 'hidden': 'visible',
              }
              return <div className="app">
                <div>
                  <Palette applyColor={this.applyColor} currentColor={this.state.currentColor} />
                  <div className='error text-muted' style={displayError} >
                    Oops, you are trying to select selected area :(
                  </div>
                </div>
                <Text selectedItems={this.state.selectedItems} addNewSelectedText={this.addSelectedText}/>
                <SidePanel selectedItems={this.state.selectedItems} removeSelection={this.removeSelectedText}/>
              </div>
            },
            addSelectedText() {
              this.setState({
                showAlert: false,
              })
              var el = document.getElementById('text');
              var sel = window.getSelection();
              var range = sel.getRangeAt(0);
              if(range.toString() === '') return;
              var preCaretRange = range.cloneRange();
              preCaretRange.selectNodeContents(el);
              preCaretRange.setEnd(range.startContainer, range.startOffset);
              var start = preCaretRange.toString().length;
              preCaretRange.setEnd(range.endContainer, range.endOffset);
              var end = preCaretRange.toString().length;
              for(var i = 0; i < this.state.selectedItems.length; i++) {
                if(this.state.selectedItems[i].start === start && this.state.selectedItems[i].end === end
                    || this.state.selectedItems[i].start > start && this.state.selectedItems[i].end < end
                    || this.state.selectedItems[i].start < start && this.state.selectedItems[i].end > end){
                    this.setState({
                      showAlert: true,
                    })
                    return;
                  }
              }
              var newItems = this.state.selectedItems;
              newItems.push({
                start: start,
                end: end,
                color: this.state.currentColor,
              });
              this.setState({
                selectedItems: newItems,
              })
              window.getSelection().empty();
            },
            removeSelectedText(start, end) {
              var newItems = this.state.selectedItems;
              for(var i = 0; i < newItems.length; i++) {
                if(newItems[i].start === start && newItems[i].end === end) {
                  newItems.splice(i, 1);
                  this.setState({
                    selectedItems: newItems,
                  })
                }
              }
            },
            applyColor(color) {
              this.setState({
                currentColor: color,
              });
            }
          });

          var Text = React.createClass({
            propTypes: {
              selectedItems: React.PropTypes.array.isRequired,
              addNewSelectedText: React.PropTypes.func.isRequired,
            },
            render() {
              var orderedSelections = this.props.selectedItems.slice();
              orderedSelections.sort(function(obj1, obj2) {
                if(obj1.start > obj2.start) return 1;
                if(obj1.start < obj2.start) return -1;
                return 0;
              });

              if(orderedSelections.length === 0) {
                return <div className="text" id='text' onMouseUp={this.highLightText}>
                    {inputText}
                </div>
              } else {
                var content = [];
                var currentPos = 0;
                var overlap = 0;
                for(var i = 0; i < orderedSelections.length; i++) {
                  if(currentPos > orderedSelections[i].start) {
                    content.pop();
                    if(overlap > 0) {
                        currentPos = overlap;
                    } else {
                        currentPos = orderedSelections[i - 1].start;
                    }
                    content.push(<span key={i + 'a'} style={{backgroundColor: orderedSelections[i-1].color}}>{inputText.slice(currentPos, orderedSelections[i].start)}</span>);
                    content.push(<span key={i + 'b'} className='highlightRed'>{inputText.slice(orderedSelections[i].start, orderedSelections[i - 1].end)}</span>);
                    content.push(<span key={i + 'c'} style={{backgroundColor: orderedSelections[i].color}}>{inputText.slice(orderedSelections[i - 1].end, orderedSelections[i].end)}</span>);
                    overlap = orderedSelections[i - 1].end;
                  } else {
                    content.push(<span key={i + 'a'}>{inputText.slice(currentPos, orderedSelections[i].start)}</span>);
                    content.push(<span key={i + 'b'} style={{backgroundColor: orderedSelections[i].color}}>{inputText.slice(orderedSelections[i].start, orderedSelections[i].end)}</span>);
                    overlap = 0;
                  }
                  currentPos = orderedSelections[i].end;
                  if(i === orderedSelections.length - 1) {
                    content.push(<span key={i + 'd'}>{inputText.slice(currentPos)}</span>);
                  }
                }

                return <div className="text" id='text' onMouseUp={this.highLightText}>
                  {content}
                </div>
              }
            },
            highLightText() {
              this.props.addNewSelectedText();
            }
          });

          var SidePanel = React.createClass({
            propTypes: {
              selectedItems: React.PropTypes.array,
              removeSelection: React.PropTypes.func.isRequired,
            },
            render() {
              var selectedElements = [];
              this.props.selectedItems.forEach(function(element, index) {
                var selectedElement =
                <li key={index}>
                  <span className="selectionTitile" style={{color:element.color}}>Selection {index + 1}: </span>
                  <div className="selectedItem">
                    {inputText.slice(element.start, element.end)}
                  </div>
                  <div className="removeSelection" onClick={this.removeSelection.bind(this, element.start, element.end)}>
                    REMOVE
                  </div>
                </li>;
                selectedElements.push(selectedElement);
              }.bind(this))
              return <div className='sidePanel'>
                <div className="sideBarTitle">
                  My selections:
                </div>
                <ul>
                  {selectedElements}
                </ul>
              </div>
            },
            removeSelection(start, end) {
                this.props.removeSelection(start, end);
            }
          });

          var Palette = React.createClass({
            propTypes: {
              applyColor: React.PropTypes.func.isRequired,
              currentColor: React.PropTypes.string.isRequired,
            },
            render() {
              if(this.props.currentColor === '#73C6B6') {
                  return <div className="palette">
                    <div className="green chosenColor" onClick={this.applyColor.bind(this, '#73C6B6')} />
                    <div className="blue" onClick={this.applyColor.bind(this, '#5499C7')}/>
                    <div className="grey" onClick={this.applyColor.bind(this, '#AAB7B8')}/>
                  </div>
              }
              if(this.props.currentColor === '#5499C7') {
                return <div className="palette">
                  <div className="green" onClick={this.applyColor.bind(this, '#73C6B6')} />
                  <div className="blue chosenColor" onClick={this.applyColor.bind(this, '#5499C7')}/>
                  <div className="grey" onClick={this.applyColor.bind(this, '#AAB7B8')}/>
                </div>
              }
              if(this.props.currentColor === '#AAB7B8') {
                return <div className="palette">
                  <div className="green" onClick={this.applyColor.bind(this, '#73C6B6')} />
                  <div className="blue" onClick={this.applyColor.bind(this, '#5499C7')}/>
                  <div className="grey chosenColor" onClick={this.applyColor.bind(this, '#AAB7B8')}/>
                </div>
              }
            },
            applyColor(newColor) {
              this.props.applyColor(newColor);
            }
          })

          ReactDOM.render(<App />, document.getElementById('app'));

        </script>
      </div>
    </div>
  </body>
</html>
